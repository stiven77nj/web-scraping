name: CI/CD Deploy to production

on:
  pull_request:
    branches: 
      - main # Deployment happens when there is a push to the main branch

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Show messages before connecting
      - name: Show connection info
        run: |
          echo "ğŸ”— Connecting to the server..."
          echo "ğŸ“ IP Address: ${{ secrets.SERVER_IP }}"
          echo "ğŸ‘¤ Username: ${{ secrets.SERVER_USERNAME }}"

      # Step 2: Connect to the server and deploy
      - name: SSH into server and deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e  # Stop execution if any step fails
            cd /home/arar/desarrollo/web-scraping || { echo "âŒ Folder not found"; exit 1; }

            echo "ğŸ”„ Pulling latest changes..."
            git pull origin main || { echo "âŒ Git pull failed"; exit 1; }

            echo "ğŸ›‘ Stopping existing container..."
            docker stop web-scraping || echo "â„¹ No container to stop"

            echo "ğŸ—‘ Removing old container..."
            docker rm web-scraping || echo "â„¹ No container to remove"

            echo "ğŸ—‘ Removing old image..."
            docker rmi web-scraping || echo "â„¹ No image to remove"

            echo "âš™ï¸ Building new image..."
            docker build -t --no-cache web-scraping .

            echo "ğŸš€ Starting new container..."
            docker run -d -p 8082:8081 --env-file .env --name web-scraping web-scraping

            echo "âœ… Deployment completed successfully"
