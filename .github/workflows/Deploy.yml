name: CI/CD Deploy to production

on:
  pull_request:
    branches: 
      - main # Deployment happens when there is a push to the main branch

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      - name: Allow safe directory
        run: git config --global --add safe.directory /home/arar/desarrollo/web-scraping

      # Step 1: Connect to the server and deploy
      - name: Build and deploy
        run: |
          set -e  # Stop execution if any step fails
          cd /home/arar/desarrollo/web-scraping || { echo "❌ Folder not found"; exit 1; }

          echo "🔄 Pulling latest changes..."
          if ! git pull origin main; then
            echo "❌ Git pull failed. Showing Git status and config for debugging:"
            git status || true
            git config --list || true
            exit 1
          fi

          echo "🛑 Stopping existing container..."
          docker stop web-scraping || echo "ℹ No container to stop"

          echo "🗑 Removing old container..."
          docker rm web-scraping || echo "ℹ No container to remove"

          echo "🗑 Removing old image..."
          docker rmi web-scraping || echo "ℹ No image to remove"

          echo "⚙️ Building new image..."
          docker build --no-cache -t web-scraping .

          echo "🚀 Starting new container..."
          docker run -d -p 8082:8081 --env-file .env --name web-scraping web-scraping

          echo "✅ Deployment completed successfully"
