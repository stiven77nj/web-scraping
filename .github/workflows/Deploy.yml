name: CI/CD Deploy to production

on:
  pull_request:
    branches: 
      - main # Deployment happens when there is a push to the main branch

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      - name: Allow safe directory
        run: git config --global --add safe.directory /home/arar/desarrollo/web-scraping

      # Step 1: Connect to the server and deploy
      - name: Build and deploy
        run: |
          set -e  # Stop execution if any step fails
          cd /home/arar/desarrollo/web-scraping || { echo "âŒ Folder not found"; exit 1; }

          echo "ğŸ”„ Pulling latest changes..."
          if ! git pull origin main; then
            echo "âŒ Git pull failed. Showing Git status and config for debugging:"
            git status || true
            git config --list || true
            exit 1
          fi

          echo "ğŸ›‘ Stopping existing container..."
          docker stop web-scraping || echo "â„¹ No container to stop"

          echo "ğŸ—‘ Removing old container..."
          docker rm web-scraping || echo "â„¹ No container to remove"

          echo "ğŸ—‘ Removing old image..."
          docker rmi web-scraping || echo "â„¹ No image to remove"

          echo "âš™ï¸ Building new image..."
          docker build --no-cache -t web-scraping .

          echo "ğŸš€ Starting new container..."
          docker run -d -p 8082:8081 --env-file .env --name web-scraping web-scraping

          echo "âœ… Deployment completed successfully"
